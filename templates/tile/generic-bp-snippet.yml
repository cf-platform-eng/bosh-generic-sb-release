---

property_blueprints:
- name: encryption_key
  type: secret
- name: vm_credentials
  type: salted_credentials
  default:
    identity: vcap
- name: buildpack_name
  type: string
  configurable: true
  default: generic-buildpack
- name: buildpack_order
  type: integer
  configurable: true
  default: 10

form_types:                                                # [8]
- property_inputs:                                       # [9]
  - reference: .properties.buildpack_name
    label: Buildpack Name
    description: 'Enter the name for the Buildpack'
  - reference: .properties.buildpack_order
    label: Order of Buildpack
    description: 'Position of Buildpack'

job_types:
- name: deploy-generic-buildpack
  resource_label: Deploy Generic buildpack
  errand: true
  templates:
  - name: deploy-generic-buildpack
    release: generic_release
  resource_definitions:
  - name: ram
    type: integer
    configurable: false
    default: 512
  - name: ephemeral_disk
    type: integer
    configurable: false
    default: 2048
  - name: persistent_disk
    type: integer
    configurable: false
    default: 0
  - name: cpu
    type: integer
    configurable: false
    default: 1
  static_ip: 0
  dynamic_ip: 1
  max_in_flight: 1
  instance_definitions:
  - name: instances
    type: integer
    configurable: false
    default: 1
  property_blueprints:
  - name: vm_credentials
    type: salted_credentials
    default:
      identity: vcap

  manifest: |
    domain: (( ..cf.cloud_controller.system_domain.value ))
    buildpack_domains:
      - (( ..cf.cloud_controller.buildpacks_domain.value ))
    ssl:
      skip_cert_verify: (( ..cf.ha_proxy.skip_cert_verify.value ))
    uaa:
      url: https://uaa.(( ..cf.cloud_controller.system_domain.value ))
      clients:
        generic_broker:
          secret: test
    generic_broker:
      buildpack_name: (( .properties.buildpack_name.value ))
      buildpack_version: (( .properties.buildpack_version.value ))

      cf:
        admin_user: (( ..cf.uaa.system_services_credentials.identity ))
        admin_password: (( ..cf.uaa.system_services_credentials.password ))

- name: delete-generic-buildpack
  resource_label: Delete buildpack
  templates:
  - name: delete-generic-buildpack
    release: generic_release
  errand: true
  resource_definitions:
  - name: ram
    type: integer
    configurable: false
    default: 512
  - name: ephemeral_disk
    type: integer
    configurable: false
    default: 1024
  - name: persistent_disk
    type: integer
    configurable: false
    default: 0
  - name: cpu
    type: integer
    configurable: false
    default: 1
  static_ip: 0
  dynamic_ip: 1
  max_in_flight: 1
  instance_definitions:
  - name: instances
    type: integer
    configurable: false
    default: 1
  property_blueprints:
  - name: vm_credentials
    type: salted_credentials
    default:
      identity: vcap

  manifest: |
    ssl:
      skip_cert_verify: (( ..cf.ha_proxy.skip_cert_verify.value ))
    generic_buildpack:
      name: (( .properties.buildpack_name.value ))
      cf:
        admin_user: (( ..cf.uaa.system_services_credentials.identity ))
        admin_password: (( ..cf.uaa.system_services_credentials.password ))

post_deploy_errands:
- name: deploy-generic-buildpack
pre_delete_errands:
- name: delete-generic-buildpack

